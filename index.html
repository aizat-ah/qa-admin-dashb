<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Website Administration Testing Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase Imports for Persistence -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
        onIdTokenChanged,
        signInWithCustomToken,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        onSnapshot,
        setDoc,
        getDocs,
        collection,
        query,
        where,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      setLogLevel("Debug");

      // =========================================================================
      // ‚ö†Ô∏è START: CONFIGURATION SECTION - YOU MUST EDIT THIS BLOCK
      // =========================================================================

      // 1. Paste your Firebase project configuration object here:
      const YOUR_FIREBASE_CONFIG = {
        // üü¢ KEEP: Your key to access Firebase services
        apiKey: "AIzaSyDzzRXeGZP1TOC8VWwIEVQJgYN85-ibVFw",

        // üü¢ KEEP: Your project's domain for authentication
        authDomain: "qa-admin-dashboard.firebaseapp.com",

        // üü¢ KEEP: Your Project ID
        projectId: "qa-admin-dashboard",

        // üü¢ KEEP: Your storage bucket URL
        storageBucket: "qa-admin-dashboard.firebasestorage.app",

        // üü¢ KEEP: Your Sender ID for push notifications
        messagingSenderId: "644969429386",

        // ‚ö†Ô∏è CRITICAL CHANGE: Use the simple App ID string only.
        appId: "1:644969429386:web:13073b41d2f36c9c353073",
        // ‚ùå REMOVE: measurementId is not needed for core services.
      };

      // 2. Define a unique App ID (This acts as the top-level container for your data)
      const YOUR_CUSTOM_APP_ID = "qa-admin-dashboard-prod";

      // =========================================================================
      // ‚ö†Ô∏è END: CONFIGURATION SECTION
      // =========================================================================

      const appId = YOUR_CUSTOM_APP_ID;
      const firebaseConfig = YOUR_FIREBASE_CONFIG;
      const LOCAL_STORAGE_KEY = "qa_dashboard_anon_token";

      const app = initializeApp(firebaseConfig);
      window.db = getFirestore(app);
      window.auth = getAuth(app);
      window.isAuthReady = false;
      window.userId = null;
      window.appId = appId;

      // Expose Firebase functions to global scope for use in the main script block
      window.onAuthStateChanged = onAuthStateChanged;
      window.setDoc = setDoc;
      window.doc = doc;
      window.onSnapshot = onSnapshot;

      async function initializeFirebase() {
        // Check for existing anonymous token in local storage
        const savedToken = localStorage.getItem(LOCAL_STORAGE_KEY);
        let user;

        try {
          if (savedToken) {
            // Re-use existing session token to ensure the same anonymous account is used
            // This relies on Firebase Auth automatically persisting the anonymous user's ID/token internally
            await window.auth.setPersistence("local"); // Ensure persistence is set
            user = window.auth.currentUser;
          }

          if (!user) {
            // Sign in anonymously if no current user (will create a new one, but save it)
            const userCredential = await signInAnonymously(window.auth);
            user = userCredential.user;
          }

          // Listen for any auth state changes (sign-in/sign-out)
          window.onAuthStateChanged(window.auth, (user) => {
            if (user) {
              window.userId = user.uid;
              window.isAuthReady = true;

              // We rely on Firebase SDK persistence, but we can log the UID
              console.log(
                "Auth State Changed. Using consistent User ID:",
                window.userId
              );

              // Once authenticated, start the application logic
              document.dispatchEvent(new Event("firebaseReady"));
            }
          });
        } catch (error) {
          console.error("Firebase Auth Error:", error);
          // Handle case where saved token is invalid or corrupted (optional: clear local storage key)
        }
      }

      initializeFirebase();
    </script>

    <style>
      /* Chart Container Styling as per requirements */
      .chart-container {
        position: relative;
        width: 100%;
        max-width: 600px; /* max-w-xl equivalent approx */
        margin-left: auto;
        margin-right: auto;
        height: 300px;
        max-height: 400px;
      }
      @media (min-width: 768px) {
        .chart-container {
          height: 350px;
        }
      }

      /* Custom scrollbar for table area */
      .custom-scroll::-webkit-scrollbar {
        width: 8px;
      }
      .custom-scroll::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      .custom-scroll::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 4px;
      }
      .custom-scroll::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
      }
      /* Style for the collapsible comment section */
      .comment-toggle-button {
        transition: transform 0.2s ease-in-out;
      }
      .comment-toggle-button.active {
        transform: rotate(180deg);
      }
    </style>
    <!-- Chosen Palette: Warm Neutrals & Professional Blue/Greens -->
    <!-- Application Structure Plan:
         1. Dashboard Header: Introduction and global progress tracking.
         2. Strategic Overview: Quantitative metrics (Charts) to understand workload distribution and current status.
         3. Test Execution Matrix: The core interactive area where users can filter by section, search, and simulate testing (changing status).
         4. Rationale: This structure moves from high-level strategy (how much work is there?) to tactical execution (testing individual items), allowing the user to manage the QA process effectively. Data is now saved persistently using YOUR custom Firebase project.
    -->
    <!-- Visualization & Content Choices:
         1. Workload Distribution (Bar Chart): Goal: Compare. Shows which admin sections (Finance, Ticket, etc.) have the most screens to test. Justification: Helps prioritize resources.
         2. Progress Status (Doughnut Chart): Goal: Inform. Real-time view of To Do vs. Passed vs. Failed. Justification: Immediate feedback on campaign health.
         3. Interactive Task List (Grid/List): Goal: Organize & Change. A filterable list that allows state changes, now persistent via Firestore. Justification: Replaces the static Markdown table with a functional, saved tool.
         4. CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. Unicode icons used instead.
    -->
  </head>
  <body
    class="bg-stone-50 text-slate-800 font-sans leading-relaxed selection:bg-orange-100 selection:text-orange-900"
  >
    <!-- Header Section -->
    <header
      class="bg-white shadow-sm border-b border-stone-200 sticky top-0 z-10"
    >
      <div
        class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex flex-col sm:flex-row justify-between items-center"
      >
        <div>
          <h1 class="text-2xl font-bold text-slate-900">QA Command Center</h1>
          <p class="text-sm text-slate-500 mt-1">
            Website Administration Module Testing - Collaborative Mode
          </p>
        </div>
        <div
          class="mt-4 sm:mt-0 flex items-center space-x-4 bg-stone-100 px-4 py-2 rounded-lg"
        >
          <div class="text-sm font-semibold text-slate-600">Status:</div>
          <span
            id="displayUserId"
            class="text-xs font-bold text-slate-700 font-mono"
            >Shared Plan</span
          >
        </div>
      </div>
      <div
        class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-3 pt-1 flex justify-end items-center"
      >
        <div
          class="flex items-center space-x-4 bg-stone-100 px-4 py-2 rounded-lg"
        >
          <div class="text-sm font-semibold text-slate-600">
            Overall Progress:
          </div>
          <div class="w-32 h-3 bg-stone-300 rounded-full overflow-hidden">
            <div
              id="globalProgressBar"
              class="h-full bg-emerald-500 w-0 transition-all duration-500"
            ></div>
          </div>
          <span
            id="globalProgressText"
            class="text-xs font-bold text-emerald-700"
            >0%</span
          >
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
      <!-- Loading Indicator -->
      <div
        id="loadingIndicator"
        class="text-center p-10 text-xl text-slate-500"
      >
        Connecting to secure database...
      </div>

      <!-- Main Content (Hidden until loaded) -->
      <div id="mainContent" class="hidden space-y-8">
        <!-- Introduction Context -->
        <section class="prose prose-stone max-w-none">
          <p class="text-lg text-slate-700">
            Welcome to the
            <strong>Administration Module Testing Dashboard</strong>. This is a
            <strong>collaborative mode</strong> where all users see and update
            the <strong>same master test plan</strong> in real-time. Changes are
            saved instantly to your shared Firebase document.
          </p>
        </section>

        <!-- KPI Cards -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div
            class="bg-white p-6 rounded-xl shadow-sm border border-stone-100 hover:shadow-md transition-shadow"
          >
            <div class="flex items-center justify-between">
              <div>
                <p
                  class="text-sm font-medium text-slate-500 uppercase tracking-wider"
                >
                  Total Test Cases
                </p>
                <p class="text-3xl font-bold text-slate-900 mt-2" id="kpiTotal">
                  0
                </p>
              </div>
              <div class="text-3xl">üìã</div>
            </div>
            <p class="text-xs text-slate-400 mt-2">Across all modules</p>
          </div>

          <div
            class="bg-white p-6 rounded-xl shadow-sm border border-stone-100 hover:shadow-md transition-shadow"
          >
            <div class="flex items-center justify-between">
              <div>
                <p
                  class="text-sm font-medium text-slate-500 uppercase tracking-wider"
                >
                  Remaining
                </p>
                <p
                  class="text-3xl font-bold text-orange-600 mt-2"
                  id="kpiRemaining"
                >
                  0
                </p>
              </div>
              <div class="text-3xl">‚è≥</div>
            </div>
            <p class="text-xs text-slate-400 mt-2">Tests marked 'To Do'</p>
          </div>

          <div
            class="bg-white p-6 rounded-xl shadow-sm border border-stone-100 hover:shadow-md transition-shadow"
          >
            <div class="flex items-center justify-between">
              <div>
                <p
                  class="text-sm font-medium text-slate-500 uppercase tracking-wider"
                >
                  Success Rate
                </p>
                <p
                  class="text-3xl font-bold text-emerald-600 mt-2"
                  id="kpiSuccess"
                >
                  0%
                </p>
              </div>
              <div class="text-3xl">üéØ</div>
            </div>
            <p class="text-xs text-slate-400 mt-2">Pass vs. Total Completed</p>
          </div>
        </section>

        <!-- Visual Analysis Section -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <!-- Workload Distribution -->
          <div
            class="bg-white p-6 rounded-xl shadow-sm border border-stone-100"
          >
            <div class="mb-4 border-b border-stone-100 pb-2">
              <h2 class="text-lg font-bold text-slate-800">
                Testing Workload Distribution
              </h2>
              <p class="text-sm text-slate-500">
                Number of test cases per functional section.
              </p>
            </div>
            <div class="chart-container">
              <canvas id="workloadChart"></canvas>
            </div>
          </div>

          <!-- Status Breakdown -->
          <div
            class="bg-white p-6 rounded-xl shadow-sm border border-stone-100"
          >
            <div class="mb-4 border-b border-stone-100 pb-2">
              <h2 class="text-lg font-bold text-slate-800">
                Current Execution Status
              </h2>
              <p class="text-sm text-slate-500">
                Real-time breakdown of test outcomes.
              </p>
            </div>
            <div class="chart-container">
              <canvas id="statusChart"></canvas>
            </div>
          </div>
        </section>

        <!-- Test Execution Matrix (Interactive List) -->
        <section
          class="bg-white rounded-xl shadow-sm border border-stone-100 overflow-hidden"
        >
          <div class="p-6 border-b border-stone-100 bg-stone-50">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-xl font-bold text-slate-800">
                Test Execution Matrix
              </h2>
              <!-- EXPORT BUTTON -->
              <button
                onclick="exportToCSV()"
                class="flex items-center space-x-2 px-3 py-1.5 bg-emerald-600 text-white rounded-lg text-sm font-semibold hover:bg-emerald-700 transition-colors shadow-md"
                title="Export all data to CSV format"
              >
                <span>Download CSV</span>
                <span>‚¨áÔ∏è</span>
              </button>
            </div>
            <p class="text-sm text-slate-600 mb-4">
              Filter the list by section to focus your testing. Click the
              actions on the right to log test results.
            </p>

            <!-- Controls -->
            <div
              class="flex flex-col md:flex-row gap-4 justify-between items-center"
            >
              <!-- Filters -->
              <div class="flex flex-wrap gap-2" id="sectionFilters">
                <!-- Buttons injected via JS -->
              </div>

              <!-- Search -->
              <div class="relative w-full md:w-64">
                <input
                  type="text"
                  id="searchInput"
                  placeholder="Search test cases..."
                  class="w-full pl-10 pr-4 py-2 border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm"
                />
                <span class="absolute left-3 top-2.5 text-stone-400">üîç</span>
              </div>
            </div>
          </div>

          <!-- List Header -->
          <div
            class="grid grid-cols-12 gap-4 px-6 py-3 bg-stone-100 text-xs font-bold text-stone-500 uppercase tracking-wider border-b border-stone-200"
          >
            <div class="col-span-1">ID</div>
            <div class="col-span-2">Section</div>
            <div class="col-span-3">Page / Sub-Menu</div>
            <div class="col-span-3">Status / Comments</div>
            <div class="col-span-3 text-right">Actions</div>
          </div>

          <!-- List Content -->
          <div
            id="testList"
            class="divide-y divide-stone-100 max-h-[600px] overflow-y-auto custom-scroll"
          >
            <!-- Rows injected via JS -->
          </div>
        </section>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-stone-200 mt-12 py-8">
      <div class="max-w-7xl mx-auto px-4 text-center text-slate-400 text-sm">
        <p>
          &copy; 2025 QA Dashboard Generator. Data saved persistently using
          Firebase (YOUR Project).
        </p>
      </div>
    </footer>

    <script>
      // --- Initial Data (used to seed Firestore if empty) ---
      const initialData = [
        // --- ADMINISTRATION SECTIONS (28 items) ---
        {
          section: "Administration: Finance",
          page: "B2G Order Entry",
          id: "FN-001",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Finance",
          page: "Inventory",
          id: "FN-002",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Finance",
          page: "Account Receivable",
          id: "FN-003",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Finance",
          page: "B2C Order Listing",
          id: "FN-004",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Finance",
          page: "B2B Order Listing",
          id: "FN-005",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Finance",
          page: "Staff Order Listing",
          id: "FN-006",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Finance",
          page: "B2G Order Entry Approval",
          id: "FN-007",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Ticket",
          page: "Ticket Management",
          id: "TK-001",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Ticket",
          page: "New Ticket",
          id: "TK-002",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Ticket",
          page: "Voucher Management",
          id: "TK-003",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Ticket",
          page: "New Voucher",
          id: "TK-004",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Ticket",
          page: "Ticket / Voucher Batch Update",
          id: "TK-005",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Pass",
          page: "Membership Profile",
          id: "PS-001",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Pass",
          page: "New Membership",
          id: "PS-002",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Pass",
          page: "Renew Membership",
          id: "PS-003",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Pass",
          page: "Membership Batch Update",
          id: "PS-004",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Customer",
          page: "B2C Customer Profile",
          id: "CU-001",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Customer",
          page: "B2B Customer Profile",
          id: "CU-002",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Customer",
          page: "B2G Group Race Result Management",
          id: "CU-003",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Customer",
          page: "B2G Group Announcement",
          id: "CU-004",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Customer",
          page: "B2G Group Team Management",
          id: "CU-005",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Customer",
          page: "B2G Group Assignment Management",
          id: "CU-006",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Report",
          page: "Manage Report",
          id: "RP-001",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Report",
          page: "Report History",
          id: "RP-002",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Expo",
          page: "Event Management",
          id: "EX-001",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Expo",
          page: "Event Merchant",
          id: "EX-002",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Expo",
          page: "Event Registration",
          id: "EX-003",
          status: "To Do",
          comment: "",
        },
        {
          section: "Administration: Fulfillment",
          page: "Delivery Fulfillment",
          id: "FL-001",
          status: "To Do",
          comment: "",
        },

        // --- CONFIGURATION SECTIONS (25 items) ---
        {
          section: "Configuration: Finance",
          page: "B2C Product Category",
          id: "CFN-001",
          status: "To Do",
          comment: "",
        },
        {
          section: "Configuration: Finance",
          page: "B2C Product",
          id: "CFN-002",
          status: "To Do",
          comment: "",
        },
        {
          section: "Configuration: Finance",
          page: "Discount Group",
          id: "CFN-003",
          status: "To Do",
          comment: "",
        },
        {
          section: "Configuration: Finance",
          page: "Discount",
          id: "CFN-004",
          status: "To Do",
          comment: "",
        },
        {
          section: "Configuration: Finance",
          page: "Reseller Product Management",
          id: "CFN-005",
          status: "To Do",
          comment: "",
        },

        {
          section: "Configuration: Expo",
          page: "Event Category",
          id: "CEX-001",
          status: "To Do",
          comment: "",
        },
        {
          section: "Configuration: Expo",
          page: "Exhibitor Category",
          id: "CEX-002",
          status: "To Do",
          comment: "",
        },
        {
          section: "Configuration: Expo",
          page: "Exhibitor User List",
          id: "CEX-003",
          status: "To Do",
          comment: "",
        },
        {
          section: "Configuration: Expo",
          page: "Exhibitor Product Category",
          id: "CEX-004",
          status: "To Do",
          comment: "",
        },
        {
          section: "Configuration: Expo",
          page: "Exhibitor Product",
          id: "CEX-005",
          status: "To Do",
          comment: "",
        },

        {
          section: "Configuration: User",
          page: "User Access",
          id: "CUS-001",
          status: "To Do",
          comment: "",
        },
        {
          section: "Configuration: User",
          page: "User Group Permission",
          id: "CUS-002",
          status: "To Do",
          comment: "",
        },
        {
          section: "Configuration: User",
          page: "User Facility",
          id: "CUS-003",
          status: "To Do",
          comment: "",
        },

        {
          section: "Configuration: System",
          page: "Store Setup",
          id: "CSY-001",
          status: "To Do",
          comment: "",
        },
        {
          section: "Configuration: System",
          page: "Facility Setup",
          id: "CSY-002",
          status: "To Do",
          comment: "",
        },
        {
          section: "Configuration: System",
          page: "Merchant Setup",
          id: "CSY-003",
          status: "To Do",
          comment: "",
        },
        {
          section: "Configuration: System",
          page: "Purchase Limit",
          id: "CSY-004",
          status: "To Do",
          comment: "",
        },

        {
          section: "Configuration: Fulfillment",
          page: "Delivery Method Setup",
          id: "CFL-001",
          status: "To Do",
          comment: "",
        },
        {
          section: "Configuration: Fulfillment",
          page: "Delivery Fee Setup",
          id: "CFL-002",
          status: "To Do",
          comment: "",
        },
        {
          section: "Configuration: Fulfillment",
          page: "Delivery API Setup",
          id: "CFL-003",
          status: "To Do",
          comment: "",
        },
      ];

      // --- State Management ---
      let appState = {
        data: [],
        filter: "All",
        searchQuery: "",
      };

      // --- Chart Instances ---
      let workloadChartInstance = null;
      let statusChartInstance = null;
      let visibleCommentId = null; // New state variable to track open comment input

      // --- Firestore Constants ---
      // CRITICAL CHANGE: Use a static document ID for shared data
      const TEST_PLAN_DOC_ID = "masterTestPlan";
      const COLLECTION_NAME = "qa_data";

      function getTestPlanDocRef() {
        if (!window.db || !window.isAuthReady) {
          console.error("Firebase not fully initialized.");
          return null;
        }
        // CRITICAL CHANGE: Path is now static and shared: /qa_data/masterTestPlan
        return doc(window.db, COLLECTION_NAME, TEST_PLAN_DOC_ID);
      }

      // --- Initialization and Data Fetching ---

      document.addEventListener("firebaseReady", () => {
        // NOTE: The User ID display is removed, but we keep the userId variable
        // for underlying security/persistence reasons.

        const docRef = getTestPlanDocRef();
        if (!docRef) return;

        // Setup real-time listener
        window.onSnapshot(
          docRef,
          async (docSnap) => {
            if (docSnap.exists()) {
              // Data exists, load it
              const savedData = docSnap.data().testItems;
              appState.data = savedData;
              console.log("Shared data loaded successfully from Firestore.");
            } else {
              // Data does not exist, initialize and save
              console.log(
                "No shared data found. Initializing and saving default data."
              );
              appState.data = initialData;
              await saveTestPlan(initialData);
            }

            document.getElementById("loadingIndicator").classList.add("hidden");
            document.getElementById("mainContent").classList.remove("hidden");

            // Initial render
            renderFilterButtons();
            updateDashboard();
          },
          (error) => {
            console.error("Error listening to Firestore changes:", error);
          }
        );

        // Search Listener
        document
          .getElementById("searchInput")
          .addEventListener("input", (e) => {
            appState.searchQuery = e.target.value.toLowerCase();
            renderTable();
          });
      });

      // --- Persistence Logic ---
      async function saveTestPlan(dataToSave) {
        const docRef = getTestPlanDocRef();
        if (!docRef) return;

        try {
          await window.setDoc(
            docRef,
            {
              testItems: dataToSave,
              updatedAt: new Date().toISOString(),
              // OPTIONAL: Keep track of who made the last change
              updatedBy: window.userId || "anonymous",
            },
            { merge: true }
          );
          console.log("Shared document saved successfully to Firestore.");
        } catch (e) {
          console.error("Error adding document: ", e);
        }
      }

      // --- CSV Export Functionality ---

      window.exportToCSV = function () {
        if (appState.data.length === 0) {
          console.log("No data to export.");
          // Use a simple non-alert message box for user feedback
          alert("Cannot export: The test plan list is empty.");
          return;
        }

        // 1. Define CSV Header (Removing User ID/App ID since data is shared)
        const headers = ["ID", "Section", "Page", "Status", "Comment"];

        // 2. Map data objects to CSV rows
        const csvRows = appState.data.map((item) =>
          [
            // Quote all fields for safety in case data contains commas
            `"${item.id}"`,
            `"${item.section}"`,
            `"${item.page}"`,
            `"${item.status}"`,
            // Escape inner quotes and ensure comments are quoted
            `"${item.comment ? item.comment.replace(/"/g, '""') : ""}"`,
          ].join(",")
        ); // Join fields with a comma

        // 3. Combine header and rows
        const csvContent = [headers.join(","), ...csvRows].join("\n"); // Join rows with a newline

        // 4. Create a Blob and trigger download
        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);

        const link = document.createElement("a");
        link.setAttribute("href", url);

        const now = new Date();
        const dateString = `${now.getFullYear()}-${(now.getMonth() + 1)
          .toString()
          .padStart(2, "0")}-${now.getDate().toString().padStart(2, "0")}`;
        link.setAttribute("download", `qa_master_report_${dateString}.csv`); // Filename for download

        // Append to body, click, and remove (to trigger the download)
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      // --- Core Logic (Unchanged) ---

      function getUniqueSections() {
        if (appState.data.length === 0) return ["All"];
        const sections = new Set(appState.data.map((item) => item.section));
        return ["All", ...Array.from(sections)];
      }

      function getStats() {
        const total = appState.data.length;
        const todo = appState.data.filter((i) => i.status === "To Do").length;
        const passed = appState.data.filter(
          (i) => i.status === "Passed"
        ).length;
        const failed = appState.data.filter(
          (i) => i.status === "Failed"
        ).length;
        const completed = passed + failed;

        // Calculate Distribution for Bar Chart
        const distribution = {};
        appState.data.forEach((item) => {
          const sectionName = item.section.split(": ")[0]; // Group by Admin or Configuration
          distribution[sectionName] = (distribution[sectionName] || 0) + 1;
        });

        return { total, todo, passed, failed, completed, distribution };
      }

      // --- Rendering Functions (Unchanged) ---

      function updateDashboard() {
        const stats = getStats();

        // Update KPIs
        document.getElementById("kpiTotal").innerText = stats.total;
        document.getElementById("kpiRemaining").innerText = stats.todo;

        const successRate =
          stats.completed > 0
            ? Math.round((stats.passed / stats.completed) * 100)
            : 0;
        document.getElementById("kpiSuccess").innerText = `${successRate}%`;

        // Update Global Progress Bar
        const overallPercent =
          stats.total > 0
            ? Math.round((stats.completed / stats.total) * 100)
            : 0;
        document.getElementById(
          "globalProgressBar"
        ).style.width = `${overallPercent}%`;
        document.getElementById(
          "globalProgressText"
        ).innerText = `${overallPercent}%`;

        // Update Charts
        renderCharts(stats);

        // Render Table
        renderTable();
      }

      function renderFilterButtons() {
        const container = document.getElementById("sectionFilters");
        const sections = getUniqueSections();

        // Reorder buttons to place Configuration sections after Administration
        const adminSections = sections
          .filter((s) => s.startsWith("Administration:") || s === "All")
          .sort();
        const configSections = sections
          .filter((s) => s.startsWith("Configuration:"))
          .sort();
        const orderedSections = [
          "All",
          ...adminSections.filter((s) => s !== "All"),
          ...configSections,
        ];

        container.innerHTML = orderedSections
          .map(
            (section) => `
                        <button 
                            onclick="setFilter('${section}')"
                            class="px-3 py-1 text-sm rounded-full transition-colors border ${
                              appState.filter === section
                                ? "bg-slate-800 text-white border-slate-800"
                                : "bg-white text-slate-600 border-stone-200 hover:bg-stone-100"
                            }"
                        >
                            ${section
                              .replace("Administration: ", "")
                              .replace("Configuration: ", "Cfg: ")}
                        </button>
                    `
          )
          .join("");
      }

      function setFilter(section) {
        appState.filter = section;
        renderFilterButtons();
        renderTable();
      }

      window.toggleComment = function (id) {
        visibleCommentId = visibleCommentId === id ? null : id;
        renderTable(); // Re-render to show/hide the comment box
        // Give time for UI to update, then focus the textarea if opening
        if (visibleCommentId === id) {
          setTimeout(() => {
            const textarea = document.getElementById(`comment-${id}`);
            if (textarea) textarea.focus();
          }, 10);
        }
      };

      window.saveComment = function (id) {
        const itemIndex = appState.data.findIndex((d) => d.id === id);
        if (itemIndex > -1) {
          const newComment = document.getElementById(`comment-${id}`).value;

          const newTestData = appState.data.map((item, index) => {
            if (index === itemIndex) {
              return { ...item, comment: newComment };
            }
            return item;
          });

          // Hide the input box after saving
          visibleCommentId = null;

          // Save and re-render
          saveTestPlan(newTestData);
        }
      };

      function renderTable() {
        const container = document.getElementById("testList");

        const filteredData = appState.data.filter((item) => {
          const matchesSection =
            appState.filter === "All" || item.section === appState.filter;
          const matchesSearch =
            item.page.toLowerCase().includes(appState.searchQuery) ||
            item.id.toLowerCase().includes(appState.searchQuery) ||
            (item.comment &&
              item.comment.toLowerCase().includes(appState.searchQuery)); // Search comments too
          return matchesSection && matchesSearch;
        });

        if (filteredData.length === 0) {
          container.innerHTML = `
                    <div class="p-8 text-center text-stone-400">
                        <p>No test cases found matching your current filters or search query.</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = filteredData
          .map((item) => {
            // Determine styling based on status
            let statusBadge = "";
            let rowBg = "hover:bg-stone-50";

            if (item.status === "Passed") {
              statusBadge =
                '<span class="px-2 py-1 text-xs font-bold bg-emerald-100 text-emerald-800 rounded">Passed</span>';
              rowBg = "bg-emerald-50/30 hover:bg-emerald-50/50";
            } else if (item.status === "Failed") {
              statusBadge =
                '<span class="px-2 py-1 text-xs font-bold bg-red-100 text-red-800 rounded">Failed</span>';
              rowBg = "bg-red-50/30 hover:bg-red-50/50";
            } else {
              statusBadge =
                '<span class="px-2 py-1 text-xs font-bold bg-stone-200 text-stone-600 rounded">To Do</span>';
            }

            const isCommentVisible = visibleCommentId === item.id;
            const commentIndicator = item.comment ? "üí¨" : "";
            const commentButtonClass = isCommentVisible ? "active" : "";

            return `
                        <div class="flex flex-col border-b border-stone-100 ${rowBg}">
                            <!-- Main Row -->
                            <div class="grid grid-cols-12 gap-4 px-6 py-4 items-center transition-colors">
                                <div class="col-span-1 text-xs font-mono text-slate-400">${
                                  item.id
                                }</div>
                                <div class="col-span-2">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-800">
                                        ${item.section
                                          .replace("Administration: ", "")
                                          .replace("Configuration: ", "Cfg: ")}
                                    </span>
                                </div>
                                <div class="col-span-3 font-medium text-slate-700">${
                                  item.page
                                }</div>
                                <div class="col-span-3 font-medium text-slate-700 flex items-center gap-2">
                                    ${statusBadge}
                                    ${commentIndicator}
                                </div>
                                <div class="col-span-3 text-right flex justify-end gap-2">
                                    <button onclick="updateStatus('${
                                      item.id
                                    }', 'Passed')" class="p-1.5 text-emerald-600 hover:bg-emerald-100 rounded transition-colors" title="Mark as Passed">
                                        ‚úÖ
                                    </button>
                                    <button onclick="updateStatus('${
                                      item.id
                                    }', 'Failed')" class="p-1.5 text-red-600 hover:bg-red-100 rounded transition-colors" title="Mark as Failed">
                                        ‚ùå
                                    </button>
                                    <button onclick="updateStatus('${
                                      item.id
                                    }', 'To Do')" class="p-1.5 text-stone-400 hover:bg-stone-200 rounded transition-colors" title="Reset">
                                        üîÑ
                                    </button>
                                    <button onclick="toggleComment('${
                                      item.id
                                    }')" class="p-1.5 text-slate-500 hover:bg-stone-200 rounded transition-colors comment-toggle-button ${commentButtonClass}" title="Add/View Comment">
                                        <span class="text-xs">‚ñº</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Collapsible Comment Section -->
                            <div id="comment-section-${item.id}" class="${
              isCommentVisible ? "block" : "hidden"
            } px-6 pb-4 pt-2 bg-stone-50/70 border-t border-stone-100">
                                <label for="comment-${
                                  item.id
                                }" class="block text-xs font-semibold text-slate-600 mb-1">Testing Notes:</label>
                                <textarea id="comment-${
                                  item.id
                                }" rows="2" class="w-full p-2 border border-stone-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Add observations, environment details, or bug descriptions...">${
              item.comment || ""
            }</textarea>
                                <button onclick="saveComment('${
                                  item.id
                                }')" class="mt-2 px-3 py-1 bg-blue-600 text-white text-xs font-medium rounded-lg hover:bg-blue-700 transition-colors">Save Comment</button>
                            </div>
                        </div>
                    `;
          })
          .join("");
      }

      function updateStatus(id, newStatus) {
        const itemIndex = appState.data.findIndex((d) => d.id === id);
        if (itemIndex > -1) {
          // Create a new array with the updated status
          const newTestData = appState.data.map((item, index) => {
            if (index === itemIndex) {
              return { ...item, status: newStatus };
            }
            return item;
          });

          // Save the new array to the database
          saveTestPlan(newTestData);
        } else {
          console.error("Test item not found:", id);
        }
      }

      function renderCharts(stats) {
        const ctxWorkload = document
          .getElementById("workloadChart")
          .getContext("2d");
        const ctxStatus = document
          .getElementById("statusChart")
          .getContext("2d");

        // --- Workload Bar Chart ---
        const labels = Object.keys(stats.distribution);
        const data = Object.values(stats.distribution);

        if (workloadChartInstance) workloadChartInstance.destroy();

        workloadChartInstance = new Chart(ctxWorkload, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Number of Screens/Tests",
                data: data,
                backgroundColor: "#3b82f6", // blue-500
                borderRadius: 4,
                barThickness: 20,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: "#f3f4f6" },
              },
              x: {
                grid: { display: false },
              },
            },
          },
        });

        // --- Status Doughnut Chart ---
        if (statusChartInstance) statusChartInstance.destroy();

        statusChartInstance = new Chart(ctxStatus, {
          type: "doughnut",
          data: {
            labels: ["To Do", "Passed", "Failed"],
            datasets: [
              {
                data: [stats.todo, stats.passed, stats.failed],
                backgroundColor: [
                  "#e5e7eb", // stone-200
                  "#10b981", // emerald-500
                  "#ef4444", // red-500
                ],
                borderWidth: 0,
                hoverOffset: 4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "70%",
            plugins: {
              legend: {
                position: "bottom",
                labels: { usePointStyle: true, padding: 20 },
              },
            },
          },
        });
      }
    </script>
  </body>
</html>
